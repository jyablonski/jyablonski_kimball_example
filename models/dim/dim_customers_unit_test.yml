unit_tests:
  - name: dim_customers_unit_test_full_refresh
    description: "Test the dim_customers model with dummy data."
    model: dim_customers
    overrides:
      macros:
        is_incremental: false
    given:
      - input: source('application_db', 'customer_audit')
        rows:
          - {
              id: 1,
              audit_type: 0, # Insert
              customer_id: 101,
              customer_name: "Alice Johnson",
              customer_email: "alice.johnson@example.com",
              address: "123 Elm Street",
              address_2: "Apt 4B",
              city: "Springfield",
              zip_code: 62704,
              state: "IL",
              country: "USA",
              created_at: "2023-01-01 09:00:00",
              modified_at: "2023-01-01 09:00:00",
            }
          - {
              id: 2,
              audit_type: 0, # Insert
              customer_id: 102,
              customer_name: "Bob Smith",
              customer_email: "bob.smith@example.com",
              address: "456 Maple Avenue",
              address_2: "",
              city: "Shelbyville",
              zip_code: 62565,
              state: "IL",
              country: "USA",
              created_at: "2023-01-02 10:30:00",
              modified_at: "2023-01-02 10:30:00",
            }
          - {
              id: 3,
              audit_type: 2, # Delete
              customer_id: 101,
              customer_name: "Alice Johnson",
              customer_email: "alice.johnson@example.com",
              address: "123 Elm Street",
              address_2: "Apt 4B",
              city: "Springfield",
              zip_code: 62704,
              state: "IL",
              country: "USA",
              created_at: "2023-01-01 09:00:00",
              modified_at: "2023-06-01 15:00:00",
            }
          - {
              id: 4,
              audit_type: 0, # Insert
              customer_id: 103,
              customer_name: "Charlie Brown",
              customer_email: "charlie.brown@example.com",
              address: "789 Oak Road",
              address_2: "Suite 12",
              city: "Capital City",
              zip_code: 63301,
              state: "MO",
              country: "USA",
              created_at: "2023-02-01 08:00:00",
              modified_at: "2023-02-01 08:00:00",
            }
    expect:
      rows:
        - {
            audit_id: 1,
            customer_id: 101,
            customer_name: "Alice Johnson",
            customer_email: "alice.johnson@example.com",
            address: "123 Elm Street",
            address_2: "Apt 4B",
            city: "Springfield",
            zip_code: 62704,
            state: "IL",
            country: "USA",
            valid_from: "2023-01-01 09:00:00",
            valid_to: "2023-06-01 15:00:00",
            is_deleted: 0,
            is_current_record: 0,
            is_latest_record: 0, # The record is marked as the latest for customer_id 101
            # dbt_updated_at: "9999-x12-31 00:00:00", # Replace with the actual timestamp generated by your process
          }
        - {
            audit_id: 3,
            customer_id: 101,
            customer_name: "Alice Johnson",
            customer_email: "alice.johnson@example.com",
            address: "123 Elm Street",
            address_2: "Apt 4B",
            city: "Springfield",
            zip_code: 62704,
            state: "IL",
            country: "USA",
            valid_from: "2023-06-01 15:00:00",
            valid_to: "2023-06-01 15:00:00",
            is_deleted: 1,
            is_current_record: 0,
            is_latest_record: 1, # The record is marked as the latest for customer_id 101
            # dbt_updated_at: "9999-x12-31 00:00:00", # Replace with the actual timestamp generated by your process
          }
        - {
            audit_id: 2,
            customer_id: 102,
            customer_name: "Bob Smith",
            customer_email: "bob.smith@example.com",
            address: "456 Maple Avenue",
            address_2: "",
            city: "Shelbyville",
            zip_code: 62565,
            state: "IL",
            country: "USA",
            valid_from: "2023-01-02 10:30:00",
            valid_to: "9999-12-31 00:00:00",
            is_deleted: 0,
            is_current_record: 1,
            is_latest_record: 1,
            # dbt_updated_at: "9999-12-31 00:00:00", # Replace with the actual timestamp generated by your process
          }
        - {
            audit_id: 4,
            customer_id: 103,
            customer_name: "Charlie Brown",
            customer_email: "charlie.brown@example.com",
            address: "789 Oak Road",
            address_2: "Suite 12",
            city: "Capital City",
            zip_code: 63301,
            state: "MO",
            country: "USA",
            valid_from: "2023-02-01 08:00:00",
            valid_to: "9999-12-31 00:00:00",
            is_deleted: 0,
            is_current_record: 1,
            is_latest_record: 1, # The record is marked as the latest for customer_id 103
            # dbt_updated_at: "9999-12-31 00:00:00", # Replace with the actual timestamp generated by your process
          }

    # for incremental runs, it's not able to test the updates that will be made to the previous records
    # https://getdbt.slack.com/archives/C01UM2N7814/p1721494717003879
    # this seems like a bug, wont work with an incremnetal test. i wrote a msg in dbt slack but no response, so
    # im commenting this test out
  # - name: dim_customers_unit_test_incremental
  #   description: "Test the dim_customers model with dummy data."
  #   model: dim_customers
  #   overrides:
  #     macros:
  #       is_incremental: true
  #   given:
  #     - input: source('application_db', 'customer_audit')
  #       rows:
  #         - {
  #             id: 3,
  #             audit_type: 2, # Delete
  #             customer_id: 101,
  #             customer_name: "Alice Johnson",
  #             customer_email: "alice.johnson@example.com",
  #             address: "123 Elm Street",
  #             address_2: "Apt 4B",
  #             city: "Springfield",
  #             zip_code: 62704,
  #             state: "IL",
  #             country: "USA",
  #             created_at: "2023-01-01 09:00:00",
  #             modified_at: "2023-06-01 09:00:00",
  #           }
  #         - {
  #             id: 4,
  #             audit_type: 1, # Update
  #             customer_id: 102,
  #             customer_name: "Bob Smith",
  #             customer_email: "bob.smith@example.com",
  #             address: "456 Maple Avenue",
  #             address_2: "",
  #             city: "Burritsville",
  #             zip_code: 32322,
  #             state: "IL",
  #             country: "USA",
  #             created_at: "2023-01-02 10:30:00",
  #             modified_at: "2023-06-02 10:30:00",
  #           }
  #     - input: this
  #       # contents of current my_incremental_model
  #       rows:
  #         - {
  #             audit_id: 1,
  #             customer_id: 101,
  #             customer_name: "Alice Johnson",
  #             customer_email: "alice.johnson@example.com",
  #             address: "123 Elm Street",
  #             address_2: "Apt 4B",
  #             city: "Springfield",
  #             zip_code: 62704,
  #             state: "IL",
  #             country: "USA",
  #             valid_from: "2023-01-01 09:00:00",
  #             valid_to: "9999-12-31 00:00:00",
  #             is_deleted: 0,
  #             is_current_record: 1,
  #             is_latest_record: 1, # The record is marked as the latest for customer_id 101
  #             # dbt_updated_at: "9999-x12-31 00:00:00", # Replace with the actual timestamp generated by your process
  #           }
  #         - {
  #             audit_id: 2,
  #             customer_id: 102,
  #             customer_name: "Bob Smith",
  #             customer_email: "bob.smith@example.com",
  #             address: "456 Maple Avenue",
  #             address_2: "",
  #             city: "Shelbyville",
  #             zip_code: 62565,
  #             state: "IL",
  #             country: "USA",
  #             valid_from: "2023-01-02 10:30:00",
  #             valid_to: "9999-12-31 00:00:00",
  #             is_deleted: 0,
  #             is_current_record: 1,
  #             is_latest_record: 1,
  #             # dbt_updated_at: "9999-12-31 00:00:00", # Replace with the actual timestamp generated by your process
  #           }
  #   expect:
  #     rows:
  #       # - {
  #       #     audit_id: 1,
  #       #     customer_id: 101,
  #       #     customer_name: "Alice Johnson",
  #       #     customer_email: "alice.johnson@example.com",
  #       #     address: "123 Elm Street",
  #       #     address_2: "Apt 4B",
  #       #     city: "Springfield",
  #       #     zip_code: 62704,
  #       #     state: "IL",
  #       #     country: "USA",
  #       #     valid_from: "2023-01-01 09:00:00",
  #       #     valid_to: "2023-06-01 09:00:00",
  #       #     is_deleted: 0,
  #       #     is_current_record: 0,
  #       #     is_latest_record: 0,
  #       #   }
  #       - {
  #           audit_id: 3,
  #           customer_id: 101,
  #           customer_name: "Alice Johnson",
  #           customer_email: "alice.johnson@example.com",
  #           address: "123 Elm Street",
  #           address_2: "Apt 4B",
  #           city: "Springfield",
  #           zip_code: 62704,
  #           state: "IL",
  #           country: "USA",
  #           valid_from: "2023-06-01 09:00:00",
  #           valid_to: "2023-06-01 09:00:00",
  #           is_deleted: 1,
  #           is_current_record: 0,
  #           is_latest_record: 1,
  #         }
  #       # - {
  #       #     audit_id: 2,
  #       #     customer_id: 102,
  #       #     customer_name: "Bob Smith",
  #       #     customer_email: "bob.smith@example.com",
  #       #     address: "456 Maple Avenue",
  #       #     address_2: "",
  #       #     city: "Shelbyville",
  #       #     zip_code: 62565,
  #       #     state: "IL",
  #       #     country: "USA",
  #       #     valid_from: "2023-01-02 10:30:00",
  #       #     valid_to: "2023-06-02 10:30:00",
  #       #     is_deleted: 0,
  #       #     is_current_record: 0,
  #       #     is_latest_record: 0,
  #       #   }
  #       - {
  #           audit_id: 4,
  #           customer_id: 102,
  #           customer_name: "Bob Smith",
  #           customer_email: "bob.smith@example.com",
  #           address: "456 Maple Avenue",
  #           address_2: "",
  #           city: "Burritsville",
  #           zip_code: 32322,
  #           state: "IL",
  #           country: "USA",
  #           valid_from: "2023-06-02 10:30:00",
  #           valid_to: "9999-12-31 00:00:00",
  #           is_deleted: 0,
  #           is_current_record: 1,
  #           is_latest_record: 1,
  #           # dbt_updated_at: "9999-12-31 00:00:00", # Replace with the actual timestamp generated by your process
  #         }
